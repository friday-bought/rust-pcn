apiVersion: v1
kind: Pod
metadata:
  name: pcn-train
  namespace: pcn-train
  labels:
    app: pcn-train
spec:
  runtimeClassName: nvidia
  restartPolicy: Never
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - theshire
  containers:
  - name: pcn-train
    image: ubuntu:24.04
    command: ["/bin/bash", "-c"]
    args:
    - |
      echo "=== PCN Training v2: expanded vocab, case-sensitive, prose-first ==="
      echo "Starting at $(date)"
      echo ""
      echo "Setting up Vulkan for wgpu..."
      apt-get update -qq && apt-get install -y -qq libvulkan1 > /dev/null 2>&1
      # Create nvidia Vulkan ICD pointing at the driver lib injected by nvidia runtime
      mkdir -p /usr/share/vulkan/icd.d
      cat > /usr/share/vulkan/icd.d/nvidia_icd.json <<ICDJSON
      {
        "file_format_version": "1.0.0",
        "ICD": {
          "library_path": "libGLX_nvidia.so.0",
          "api_version": "1.3"
        }
      }
      ICDJSON
      echo "Vulkan ICD written"
      echo "GPU check:"
      nvidia-smi || echo "No nvidia-smi"
      echo ""
      echo "Running training..."
      cd /workspace
      exec ./target/release/pcn-train \
        --books-dir data/books \
        --checkpoint-dir data/checkpoints \
        --metrics-file data/output/metrics.jsonl \
        --gpu \
        --epochs 2 \
        --max-samples-per-book 5000 \
        --batch-size 512 \
        --books-per-round 1
    env:
    - name: TZ
      value: America/New_York
    - name: NVIDIA_DRIVER_CAPABILITIES
      value: compute,utility
    - name: NVIDIA_VISIBLE_DEVICES
      value: all
    - name: RUST_BACKTRACE
      value: "1"
    resources:
      requests:
        cpu: "4"
        memory: 4Gi
        nvidia.com/gpu: "1"
      limits:
        cpu: "8"
        memory: 32Gi
        nvidia.com/gpu: "1"
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    workingDir: /workspace
  volumes:
  - name: workspace
    hostPath:
      path: /home/kadajett/dev/rust-pcn
      type: Directory
